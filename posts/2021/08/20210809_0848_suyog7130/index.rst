.. title: astropy@GSoC Blog Post #6, Week 8&9
.. slug:
.. date: 2021-08-09 08:48:00 
.. tags: Astropy
.. author: Suyog Garg
.. link: https://suyog20.blogspot.com/2021/08/astropygsoc-blog-post-6-week-8.html
.. description:
.. category: gsoc2021


.. raw:: html

    <b>Heads-up about the Progress of   <a href="https://github.com/astropy/astropy/pull/11897">#11897</a></b><div><br /></div><div>  In summary the situation of the concerned PR a few days back was 4 types of CI   test errors, one bug and possibly a need for modification of part of the code   copied from pycdsreadme. All these have been taken care of as detailed below,   but for the numpy depreciation warnings that keep coming up. I don't think we   can do anything about the latter's persistence as of now. I shall comment more   about it on GitHub as well. </div><div>  <ol style="text-align: left;">    <li>      <i>File not found error</i>: Moritz's HW, i.e. using       <span style="font-family: courier;">get_pkg_data_filename</span> import,       directly took care of this.     </li>    <li>      <i>Error in coord col decimal places</i>: The precision of the coordinate       component columns was getting set arbitrarily, which created difference in       the output for 32-bit and 62-bit machines, and possibly between different       operating systems. This has been corrected by having a fixed number of 12       digits after decimal for <b>RAs,</b>&nbsp;<b>DEs</b> and the       latitude/longitude columns of Galactic and Ecliptic coords. This error       also relates with the Formats bug.     </li>    <li>      <span style="font-family: courier;"><i>SphericalRepresentation</i></span><i> col error</i>: Now, this was a bit major issue compared to the two       above, although the solution was only 2 line changes. When the coords cols       were checked for and divided into components, the original SkyCoord col       was deleted right within the loop. This made the iteration index of the       loop to point to i+2 column after deletion, where i is the index of the       original <span style="font-family: courier;">SkyCoord</span> col. That is,       effectively skipping the immediate next column after the       <span style="font-family: courier;">SkyCoord</span> col, as it would have       receded by one place in the list. Got this fixed by popping the original       <span style="font-family: courier;">SkyCoord</span> col after all the       columns in the table have been iterated over. This way all       <span style="font-family: courier;">object</span> type columns are       converted to <span style="font-family: courier;">Column</span> objects       with <span style="font-family: courier;">str</span> values.     </li>    <li>      <i>~table.tests and </i><span style="font-family: courier;"><i>test_write</i></span><i> failures</i>: All these errors were warnings due to depreciation of       numpy specific aliases for different Python types. Most previous tests in       Astropy appear to use these now depreciated numpy types, which raises       warnings during testing our code. I have been able to provide remedy for       majority of these by additionally using       <span style="font-family: courier;">np.issubdtype(col.dtype, np.integer)</span>      while checking if the columns has integer values, however, tests with       oldest supported version of all dependencies still fails. See my GitHub       comment for more info.     </li>  </ol>  <i><div><i><br /></i></div>The </i><span style="font-family: courier;"><i>formats</i></span><i> bug</i></div><div><i><br /></i></div><div>  This was another major problem we had stumbled upon. It took me a while to   skim through various docs and codes to find the optimum fix for this. </div><div><br /></div><div>  Our initial insight was that the difference between the Byte-By-Byte   description and the data part of the written table, when the   <span style="font-family: courier;">formats</span> argument is passed to the   <span style="font-family: courier;">write</span> function, related in some   manner to the string formatting part of the code. By first look itself, it was   evident that there isn't any provision in the writer for cases when the   columns already contain a   <span style="font-family: courier;">format</span> attribute, which is what is   assigned when <span style="font-family: courier;">formats</span> is passed, as   I had written here back then. Creating allowance for this was easy enough,   right away correcting the test outputs. Now, both the Byte-By-Byte and the   table data had the number of decimal digits, or whatever other format for that   matter, we wanted them to have. Apart from the internally created coordinate   component columns, for which the number of digits after decimal was fixed. </div><div><br /></div><div>  It is when we want to go a step further than this and wanna truncate or   eradicate the string formatting part to obtain the column format, that we   stumble upon a road block. There are two concerns, </div><div>  <ul style="text-align: left;">    <li>      If no <span style="font-family: courier;">formats</span> argument is       passed, <span style="font-family: courier;">col.format</span> will be set       to <span style="font-family: courier;">None</span>.     </li>    <li>      Even if we already know the column format, say       <span style="font-family: courier;">.5f</span>, we still need to evaluate       the maximum size of the value strings of the column in most cases, and do       some formatting to have the format in CDS/MRT recommendation,       <span style="font-family: courier;">Fx.5</span>.     </li>  </ul>  The column <span style="font-family: courier;">formats</span> passed in the   formats argument are set by using the in-build Python function   <span style="font-family: courier;">format</span> (<a href="https://docs.python.org/3/library/functions.html#format">https://docs.python.org/3/library/functions.html#format</a>). For cases when no formats argument is passed, the default behavior when   writing the table data, for instance in the   <span style="font-family: courier;">FixedWidth</span> writer is to set the   column format to <span style="font-family: courier;">''</span> which is   equivalent to saying   <span style="font-family: courier;">val = str(val)</span>. (<a href="https://docs.astropy.org/en/stable/table/construct_table.html#table-format-string">https://docs.astropy.org/en/stable/table/construct_table.html#table-format-string</a>) <span style="font-family: courier;">FixedWidth</span> uses the maximum   length of these strings to get the column widths.   <b>So, there the string formatting part of the code is essential if we want to     know the correct format for columns without string values.</b></div><div><br /></div><div>  However, there may be another solution to this that can be tried in the   long-term. I was curious to know what other writers in Astropy did in such   situations when the column format needs to be given explicitly in the header   of the written table. There aren't extravagantly many such use cases, but the   FITS standard tables do have format keywords in the header as serve the   purpose well. So, looking over the Astropy FITS writer, I found the way in   which it deals with the problem of assigning column formats is by separately   defining all the formats that can be and then using a custom   <span style="font-family: courier;">Column</span> class which has some default   format attributes. (See:<br /><a href="https://github.com/astropy/astropy/blob/main/astropy/io/fits/column.py">https://github.com/astropy/astropy/blob/main/astropy/io/fits/column.py</a>). ASCII writers also have a custom   <span style="font-family: courier;">Column</span> class, but the attributes   that it currently has are exceedingly lacking to be of any use to us now. (<a href="https://github.com/astropy/astropy/blob/79323de928e87827526ed8fce04986a5dd459794/astropy/io/ascii/core.py#L270">https://github.com/astropy/astropy/blob/79323de928e87827526ed8fce04986a5dd459794/astropy/io/ascii/core.py#L270</a>) In the long-run, we could take motivation from the FITS writer and make   changes herein.<br /><br /><i>Other updates</i></div><div>  <i><br /></i>  <div>    <div>      I have began to work on the other two branches for Time cols and MRT       metadata resp and would have them done in some time.     </div>    <div>      On an unrelated note, I found that the       <span style="font-family: courier;">test_cds_header_from_readme.py</span>      test file in       <span style="font-family: courier;"><a href="http://astropy.io/">astropy.io</a>.ascii.tests</span>      contains some CDS reading tests. It was recently modified by the 11593 PR       (<a href="https://github.com/astropy/astropy/pull/11593/files">https://github.com/astropy/astropy/pull/11593/files</a>). I imagine that these tests can be incorporated within test_cds.py and       then we won't perhaps have to move CDS/MRT tests to any other test file?     </div>  </div></div>
    <!-- TEASER_END -->

